name: Deploy to AWS EC2

on:
  push:
    branches: [main]
  workflow_run:
    workflows: ['CI']
    types: [completed]
    branches: [main]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Check code
        uses: actions/checkout@v4

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          command_timeout: 10m
          envs: N8N_PASSWORD,DOCKER_USERNAME
          script: |
            echo "üöÄ Starting deployment..."
            
            # Verificar directorio de trabajo
            if [ ! -d "/app" ]; then
              echo "‚ùå /app directory missing, creating..."
              sudo mkdir -p /app
              sudo chown ubuntu:ubuntu /app
            fi
            
            cd /app || exit 1
            
            # Verificar git repository
            if [ ! -d ".git" ]; then
              echo "‚ùå Git repo missing, cloning..."
              git clone git@github.com:CristianMacha/ci-cd-backend.git .
            fi

            echo "üì• Pulling latest code..."
            git pull origin main || exit 1
            
            # Verificar archivos cr√≠ticos
            if [ ! -f "docker-compose.yml" ]; then
              echo "‚ùå docker-compose.yml missing!"
              exit 1
            fi
            
            if [ ! -f "Dockerfile" ]; then
              echo "‚ùå Dockerfile missing!"
              exit 1
            fi

            echo "üî® Deploying with Docker Hub image..."
            
            # Pull latest image from Docker Hub (built in CI)
            echo "üì• Pulling latest image from Docker Hub..."
            export N8N_PASSWORD=$N8N_PASSWORD
            export DOCKER_USERNAME=$DOCKER_USERNAME
            docker pull $DOCKER_USERNAME/nestjs-backend:latest
            
            echo "üîÑ Quick container swap..."
            # Parar solo la app (nginx sigue corriendo)
            docker stop nestjs-app || true
            docker rm nestjs-app || true
            
            # Solo levantar la app nueva (n8n y nginx siguen corriendo)
            docker-compose up -d app
            
            # Asegurar que n8n est√© corriendo primero
            echo "üîÑ Ensuring n8n is running..."
            docker-compose up -d --no-deps n8n
            
            # Verificar que n8n est√© saludable
            sleep 3
            if ! docker ps | grep -q "n8n-automation.*Up"; then
              echo "‚ùå n8n failed to start properly"
              docker logs n8n-automation --tail 10
              exit 1
            fi
            
            # Manejar nginx de forma robusta
            echo "üîÑ Managing nginx proxy..."
            if docker ps | grep -q "nginx-proxy.*Restarting"; then
              echo "üîß nginx is crashlooping, fixing..."
              docker stop nginx-proxy || true
              docker rm nginx-proxy || true
            fi
            
            # Levantar nginx solo despu√©s de que n8n est√© listo
            docker-compose up -d nginx
            sleep 2
            
            # Verificar que nginx est√© funcionando
            if ! docker ps | grep -q "nginx-proxy.*Up"; then
              echo "‚ùå nginx failed to start"
              docker logs nginx-proxy --tail 10
              exit 1
            fi

            echo "‚úÖ Quick health check..."
            
            # Verificaci√≥n ultra-r√°pida
            sleep 1
            if curl -s http://localhost:3000/health > /dev/null; then
              echo "‚úÖ App healthy"
            else
              echo "‚ö†Ô∏è App starting, waiting 2s..."
              sleep 2
              if curl -s http://localhost:3000/health > /dev/null; then
                echo "‚úÖ App healthy after restart"
              else
                echo "‚ùå App failed to start"
                docker logs nestjs-app --tail 20
                exit 1
              fi
            fi

            echo "üéâ Deployment completed successfully!"
        env:
          N8N_PASSWORD: ${{ secrets.N8N_PASSWORD }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
