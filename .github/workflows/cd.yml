name: Deploy to AWS EC2

on:
  push:
    branches: [main]
  workflow_run:
    workflows: ['CI']
    types: [completed]
    branches: [main]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Zero-downtime deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          command_timeout: 15m
          script: |
            cd /app
            git pull origin main

            # Build nueva imagen
            docker build -t nestjs-app:latest .

            # Ejecutar nuevo container en puerto temporal
            docker run -d --name nestjs-app-new -p 3001:3000 nestjs-app:latest

            echo "⏳ Waiting for container startup..."
            sleep 5

            # Health check con timeout
            echo "🔍 Starting health check..."
            for i in {1..30}; do
              if curl -f http://localhost:3001/health 2>/dev/null; then
                echo "✅ New container is healthy!"

                # Swap containers sin downtime
                docker stop nestjs-app || true
                docker rm nestjs-app || true
                docker stop nestjs-app-new
                docker run -d --name nestjs-app -p 3000:3000 nestjs-app:latest
                docker rm nestjs-app-new || true

                echo "🚀 Zero-downtime deployment completed!"
                exit 0
              fi
              echo "⏳ Health check attempt $i/30..."
              sleep 1
            done

            # Si llega aquí, falló
            echo "❌ Health check failed - rolling back"
            docker stop nestjs-app-new || true
            docker rm nestjs-app-new || true
            echo "🔄 Old container still running"
            exit 1
